<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LeafIot Dashboard</title>
  <link rel="stylesheet" href="index11.css" />
  <link href="https://fonts.cdnfonts.com/css/sf-pro-display" rel="stylesheet" />
  <link rel="shortcut icon" href="tnamn.png" type="image/x-icon" />
</head>
<body>
  <div class="page">
    <!-- HEADER / LOGO -->
    <header class="logo-bar">
      <img src="logoleafiot.png" alt="LeafIot Logo" class="logo-img" />
    </header>

    <!-- KARTU PUTIH UTAMA -->
    <main class="main-card">
      <!-- KIRI -->
      <section class="left-panel">
        <!-- WELCOME -->
        <section class="welcome-block">
          <h1 class="welcome-title">
            <span class="welcome-hai">Hai,</span><br />
            <span class="welcome-selamat">Selamat Datang</span>
          </h1>
        </section>

        <!-- CAMERA -->
        <section class="camera-block">
          <div class="camera-label">Camera</div>
          <div class="camera-frame">
            <img id="camera-stream" alt="Camera Stream" />
          </div>
        </section>

        <!-- JAM + ICON + TEMP/HUM -->
        <section class="jit-row">
          <div class="jit-card jit-time">
            <div class="jit-time-icon">ðŸ•’</div>
            <div class="jit-time-text">
              <span id="time-value">--:-- WIB</span>
            </div>
          </div>

          <div class="jit-card jit-icon">
            <img src="smart-farming.png" alt="Smart Farming Icon" />
          </div>

          <div class="jit-card jit-temp">
            <div class="jit-temp-labels">
              <span class="jit-temp-title">Temperature:</span>
              <span class="jit-temp-value" id="temp-value"><b>-- Â°C</b></span>
            </div>
            <div class="jit-temp-labels">
              <span class="jit-temp-title">Humidity:</span>
              <span class="jit-temp-value" id="hum-value"><b>-- %</b></span>
            </div>
          </div>
        </section>
      </section>

      <!-- KANAN -->
      <section class="right-panel">
        <!-- ROW POT -->
        <section class="pots-row">
          <!-- POT 1 -->
          <article class="pot-card">
            <div class="pot-header">Pot 1</div>
            <div class="pot-body">
              <div class="pot-line">
                <span>Sudah Matang:</span>
                <div class="pot-value nilai-matang1"><b>0 Buah</b></div>
              </div>
              <div class="pot-line">
                <span>Belum Matang:</span>
                <div class="pot-value belum-matang1"><b>0 Buah</b></div>
              </div>
            </div>
            <img src="cabai.png" alt="Chili" class="pot-image" />
          </article>

          <!-- POT 2 -->
          <article class="pot-card">
            <div class="pot-header">Pot 2</div>
            <div class="pot-body">
              <div class="pot-line">
                <span>Sudah Matang:</span>
                <div class="pot-value nilai-matang2"><b>0 Buah</b></div>
              </div>
              <div class="pot-line">
                <span>Belum Matang:</span>
                <div class="pot-value belum-matang2"><b>0 Buah</b></div>
              </div>
            </div>
            <img src="cabai.png" alt="Chili" class="pot-image" />
          </article>

          <!-- POT 3 -->
          <article class="pot-card">
            <div class="pot-header">Pot 3</div>
            <div class="pot-body">
              <div class="pot-line">
                <span>Sudah Matang:</span>
                <div class="pot-value nilai-matang3"><b>0 Buah</b></div>
              </div>
              <div class="pot-line">
                <span>Belum Matang:</span>
                <div class="pot-value belum-matang3"><b>0 Buah</b></div>
              </div>
            </div>
            <img src="cabai.png" alt="Chili" class="pot-image" />
          </article>

          <!-- POT 4 -->
          <article class="pot-card">
            <div class="pot-header">Pot 4</div>
            <div class="pot-body">
              <div class="pot-line">
                <span>Sudah Matang:</span>
                <div class="pot-value nilai-matang4"><b>0 Buah</b></div>
              </div>
              <div class="pot-line">
                <span>Belum Matang:</span>
                <div class="pot-value belum-matang4"><b>0 Buah</b></div>
              </div>
            </div>
            <img src="cabai.png" alt="Chili" class="pot-image" />
          </article>
        </section>

        <!-- HISTORY LOG -->
        <section class="history-block">
          <div class="history-header">History Log:</div>
          <div class="history-body data-log" id="history-log">
            Belum ada data...
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
  // GANTI sesuai IP/domain backend FastAPI kamu
  const API_BASE = "http://leafiot.ksmiotupnvj.com:8000";

  async function fetchJSON(path, options = {}) {
    const res = await fetch(API_BASE + path, options);
    if (!res.ok) {
      throw new Error(`HTTP ${res.status} for ${path}`);
    }
    return res.json();
  }

  /* ================== CAMERA ================== */
  function refreshCamera() {
    const img = document.getElementById("camera-stream");
    if (!img) return;

    // tambahkan timestamp biar nggak ke-cache
    img.src = API_BASE + "/chili/image?t=" + Date.now();
  }

  /* ================== DHT (TEMP & HUMID) ================== */
  async function refreshDHT() {
    try {
      // SESUAIKAN path jika di backend beda (misal /dht)
      const data = await fetchJSON("/sensor/dht");

      const tempEl = document.getElementById("temp-value");
      const humEl = document.getElementById("hum-value");

      if (tempEl) {
        const t =
          data.temperature !== null && data.temperature !== undefined
            ? data.temperature.toFixed(1) + "Â°C"
            : "-- Â°C";
        tempEl.innerHTML = "<b>" + t + "</b>";
      }

      if (humEl) {
        const h =
          data.humidity !== null && data.humidity !== undefined
            ? data.humidity.toFixed(1) + "%"
            : "-- %";
        humEl.innerHTML = "<b>" + h + "</b>";
      }
    } catch (err) {
      console.error("Error refreshDHT:", err);
    }
  }

  /* ================== WAKTU ================== */
  async function refreshTime() {
    try {
      // SESUAIKAN path kalau di backend beda
      const data = await fetchJSON("/device/time");
      const timeEl = document.getElementById("time-value");
      if (!timeEl) return;

      const label = data.last_datetime
        ? `${data.last_datetime} (${data.last_device || "Device"})`
        : "--:-- WIB";

      timeEl.textContent = label;
    } catch (err) {
      console.error("Error refreshTime:", err);
    }
  }

  /* ================== GLOBAL CHILI STATUS (HISTORY LOG) ================== */
  async function refreshChiliStatus() {
  try {
    // Ambil sekaligus: status global + riwayat pot
    const [chili, potDb] = await Promise.all([
      fetchJSON("/chili/status"),
      fetchJSON("/pot/db"),
    ]);

    const historyEl = document.getElementById("history-log");
    if (!historyEl) return;

    const now = new Date().toLocaleString("id-ID");

    const total = chili.total_detected ?? chili.total ?? 0;
    const ripe = chili.ripe ?? 0;
    const unripe = chili.unripe ?? 0;
    const lastPred = chili.last_pred ?? -1;

    // Cari last scanned pot dari /pot/db (entry terakhir)
    let lastPot = "-";
    if (Array.isArray(potDb) && potDb.length > 0) {
      const last = potDb[potDb.length - 1];
      lastPot =
        last.pot ??
        last.pot_id ??
        last.pot_number ??
        last.no_pot ??
        "-";
    }

    // Tambahkan info pot ke baris log
    const line =
      `[${now}] ` +
      `pot=${lastPot}, ` +
      `total=${total}, ` +
      `ripe=${ripe}, unripe=${unripe}, ` +
      `last_pred=${lastPred} (0=matang,1=belum,-1=tidak ada)`;

    const existing = historyEl.innerHTML
      .split("<br>")
      .filter((l) => l.trim() !== "");

    const maxLines = 50;
    const newHtml = [line, ...existing].slice(0, maxLines).join("<br>");
    historyEl.innerHTML = newHtml;
  } catch (err) {
    console.error("Error refreshChiliStatus:", err);
  }
}

  /* ================== POT PER-POT ================== */
  // Ambil data dari /pot/result dan isi kartu POT 1â€“4
  async function refreshPotResult() {
    try {
      // ambil data dari backend
      const data = await fetchJSON("/pot/result");
      console.log("pot/result =>", data);

      // data expected: { "1": {ripe, unripe}, "2": {...}, ... }
      const potIds = [1, 2, 3, 4];

      potIds.forEach((potId) => {
        // coba akses pakai key number dan string (backend bisa kirim "1" atau 1)
        const row = data[potId] || data[String(potId)] || null;

        const ripe = row && typeof row.ripe === "number" ? row.ripe : 0;
        const unripe = row && typeof row.unripe === "number" ? row.unripe : 0;

        const matangEl = document.querySelector(".nilai-matang" + potId);
        const belumEl = document.querySelector(".belum-matang" + potId);

        if (matangEl) {
          matangEl.innerHTML = "<b>" + ripe + " Buah</b>";
        }
        if (belumEl) {
          belumEl.innerHTML = "<b>" + unripe + " Buah</b>";
        }
      });
    } catch (err) {
      console.error("Error refreshPotResult:", err);
    }
  }

  /* ================== START DASHBOARD ================== */
  function startDashboard() {
    // Jalankan sekali di awal
    refreshCamera();
    refreshDHT();
    refreshTime();
    refreshChiliStatus();
    refreshPotResult();

    // Lalu jalankan berkala
    setInterval(refreshCamera, 3000);        // refresh gambar tiap 3 detik
    setInterval(refreshDHT, 5000);           // DHT tiap 5 detik
    setInterval(refreshTime, 7000);          // waktu tiap 7 detik
    setInterval(refreshChiliStatus, 8000);   // log global tiap 8 detik
    setInterval(refreshPotResult, 8000);     // pot per-pot tiap 8 detik
  }

  document.addEventListener("DOMContentLoaded", startDashboard);
</script>
</body>
</html>




